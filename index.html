<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ナンプレ解析結果</title>
</head>

<body>
    <h1>ナンプレ解析結果</h1>
    <input type="file" id="imageUpload" accept="image/*">
    <pre id="output"></pre>
    <script src="https://cdn.rawgit.com/naptha/tesseract.js/1.0.10/dist/tesseract.js"></script>
    <script>
        document.getElementById('imageUpload').addEventListener('change', handleImageUpload);

        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const img = new Image();
                    img.onload = function () {
                        processImage(img);
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        function processImage(image) {
            const rows = 9;
            const cols = 9;
            const startX = 32; // 左上の頂点X座標
            const startY = 161; // 左上の頂点Y座標
            const cellWidth = 76; // 幅
            const cellHeight = 76; // 高さ

            let promises = [];

            for (let row = 0; row < rows; row++) {
                for (let col = 0; col < cols; col++) {
                    let x = startX + col * cellWidth;
                    let y = startY + row * cellHeight;
                    promises.push(sliceAndRecognize(image, x, y, cellWidth, cellHeight));
                }
            }

            Promise.all(promises).then(results => {
                let output = '';

                // 出力をフォーマット
                results.forEach(value => {
                    if (value === '') {
                        output += '\n'; // 空白行
                    } else {
                        output += value + '\n'; // 数字
                    }
                });

                // 結果をクリップボードにコピー
                copyToClipboard(output);

                // 結果を表示
                document.getElementById('output').innerText = output;
            });
        }

        function sliceAndRecognize(image, x, y, width, height) {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(image, x, y, width, height, 0, 0, width, height);
                canvas.toBlob((blob) => {
                    const fileReader = new FileReader();
                    fileReader.onload = (e) => {
                        Tesseract.recognize(e.target.result, 'eng', {
                            tessedit_char_whitelist: '0123456789'
                        })
                            .then(result => {
                                const text = result.text.trim();
                                const confidence = result.confidence;
                                if (text.match(/^\d+$/) && confidence >= 80) {
                                    resolve(text);
                                } else {
                                    resolve(''); // OCR失敗時は空白
                                }
                            })
                            .catch(() => {
                                resolve(''); // OCRエラー時も空白
                            });
                    };
                    fileReader.readAsDataURL(blob);
                });
            });
        }

        // テキストをクリップボードにコピーする関数
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                console.log('コピーしました: ', text);
            }).catch(err => {
                console.error('クリップボードにコピーできませんでした: ', err);
            });
        }
    </script>
</body>

</html>
